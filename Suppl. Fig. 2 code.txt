data<-read.table("all_strains_bedgraph_forR.txt", header=TRUE)
data$midpoint <- (data$Start + data$Stop) /2

# Now aggregate data using aggregate function
agg <- aggregate(data$Coverage, by = list(data$Chromosome, data$Strain), mean)
names(agg)[1] <- "Chromosome"
names(agg)[2] <- "Strain"
names(agg)[3] <- "Coverage"

# Means for strains
agg2 <- aggregate(. ~ Strain, agg[-1], mean)

# Use the means to test whether the strains have > 4X mean coverage and exclude if so
for (row in 1:nrow(data)) {
	cov <- data[row,]$Coverage
	too_high <- 4 * agg2[agg2$Strain==data[row,]$Strain,]$Coverage
    if(cov > too_high) {
    data[row,]$Coverage <- NA
    }
}
# print out the new data
write.table(data,"all_strains_bedgraph_forR_censured.txt", sep="\t")

# Re-average data and print
agg <- aggregate(data$Coverage, by = list(data$Chromosome, data$Strain), mean, na.rm=T)
names(agg)[1] <- "Chromosome"
names(agg)[2] <- "Strain"
names(agg)[3] <- "Coverage"
write.table(agg, "coverage_by_chromosome.txt", sep="\t")
agg2 <- aggregate(. ~ Strain, agg[-1], mean)
write.table(agg2, "coverage_by_strain.txt", sep="\t")

# Make table for heatmap
agg$standchrom = agg$Coverage / ave(agg$Coverage, agg$Strain)

library("ggplot2")

xlevel_order <- c('cneoH99_Chr01', 'cneoH99_Chr02', 'cneoH99_Chr03', 'cneoH99_Chr04', 'cneoH99_Chr05','cneoH99_Chr06','cneoH99_Chr07','cneoH99_Chr08','cneoH99_Chr09', 'cneoH99_Chr10','cneoH99_Chr11','cneoH99_Chr12','cneoH99_Chr13','cneoH99_Chr14') 
ylevel_order<-c('CB-100-1', 'CB-100-2', 'CB-100-3', 'CB-100-5', 'CB-100-6', 'CC-100-1', 
'CC-100-2', 'CC-100-3', 'CC-100-4', 'CC-100-5', 'CC-100-6', 'CN-100-1', 'CN-100-2', 'CN-100-3', 'CN-100-4',
'CN-100-5', 'CN-100-6', 'CW-100-1', 'CW-100-2', 'CW-100-3', 'CW-100-4', 'CW-100-5', 'CW-100-6', 'CY-100-1',
'CY-100-2', 'CY-100-3', 'CY-100-4', 'CY-100-5', 'CY-100-6', 'P1W10', 'P2W10', 'P3W10', 'P4W10', 'P5W10', 'P6W10', 'SSD719_vitro', 'SSD719_vivo', 'EM3', 'YSB121')
ylabs <- length(ylevel_order)

agg$standchrom_breaks <- cut(agg$standchrom,breaks = c(-Inf,0.65,0.75,1.20,1.35,Inf),right = FALSE)

chr.heatmap <- ggplot(data = agg, mapping = aes(x = factor(Chromosome, level = xlevel_order), y = factor(Strain, level = ylevel_order), fill = standchrom_breaks)) +
  geom_tile(color = "gray") + xlab(label = "Chromosome") + ylab(label = "Strain") + scale_x_discrete(labels=c("cneoH99_Chr01" = "1", "cneoH99_Chr02" = "2", "cneoH99_Chr03" = "3",
 "cneoH99_Chr04" = "4", "cneoH99_Chr05" = "5", "cneoH99_Chr06" = "6",  "cneoH99_Chr07" = "7", "cneoH99_Chr08" = "8", "cneoH99_Chr09" = "9",
  "cneoH99_Chr10" = "10", "cneoH99_Chr11" = "11", "cneoH99_Chr12" = "12","cneoH99_Chr13" = "13", "cneoH99_Chr14" = "14")) + 
  scale_fill_manual(breaks=c("[0.75,1.2)", "[1.2,1.35)",  "[1.35, Inf)"),
                     values = c("white", "orange", "red")) +
  theme(axis.title=element_text(size=14),  axis.text.x = element_text(size = 12)) + scale_y_discrete(position = "right") 
chr.heatmap
